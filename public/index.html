<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex Timesheets</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #d0d0d0;
            min-height: 100vh;
        }

        header {
            background: #141414;
            padding: 24px 40px;
            border-bottom: 2px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: 1px;
        }

        header h1 span { color: #aaa; }

        .stats {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #888;
        }

        .stats .stat-value {
            color: #fff;
            font-weight: 700;
            font-size: 16px;
        }

        .controls {
            padding: 16px 40px;
            background: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
        }

        .controls button {
            background: #333;
            color: #ddd;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .controls button:hover { background: #444; }

        .controls .week-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .controls .week-nav button {
            background: #222;
            padding: 6px 14px;
        }

        .controls .week-nav button:hover { background: #333; }

        .controls .week-nav span {
            font-size: 14px;
            min-width: 120px;
            text-align: center;
            color: #999;
        }

        .table-container {
            padding: 20px 40px 40px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #111;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        thead th {
            background: #1a1a1a;
            padding: 14px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #333;
        }

        thead th:first-child {
            text-align: left;
            min-width: 180px;
        }

        /* Row states */
        tbody tr {
            transition: background 0.15s;
            border-left: 4px solid transparent;
        }

        tbody tr:hover { background: #1a1a1a; }

        /* Default untouched row */
        tbody tr { background: #0e0e0e; }

        /* Green: all 3 meals ticked */
        tbody tr.complete {
            background: #0a1f0a;
            border-left: 4px solid #2ecc40;
        }

        /* Red: partially ticked (1 or 2) */
        tbody tr.incomplete {
            background: #1f0a0a;
            border-left: 4px solid #e74c3c;
        }

        /* Today highlight */
        tbody tr.today td:first-child {
            position: relative;
        }

        tbody tr.today .date-cell {
            background: #fff;
            color: #000;
            padding: 6px 10px;
            border-radius: 6px;
            display: inline-flex;
        }

        tbody tr.today .date-cell .day-name {
            color: #333;
        }

        tbody tr.today .date-cell .date-text {
            color: #000;
            font-weight: 700;
        }

        tbody td {
            padding: 10px 20px;
            text-align: center;
            border-bottom: 1px solid #1a1a1a;
            font-size: 14px;
        }

        tbody td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .date-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .date-cell .day-name {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-cell .date-text {
            font-size: 14px;
            color: #ccc;
        }

        /* Meal cell */
        .meal-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .meal-top {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meal-label {
            font-size: 11px;
            color: #777;
            white-space: nowrap;
        }

        .tick-time {
            font-size: 10px;
            color: #555;
            margin-top: 2px;
        }

        /* Checkbox */
        .checkbox-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .checkbox-wrapper input[type="checkbox"] { display: none; }

        .checkbox-wrapper label {
            width: 28px;
            height: 28px;
            border: 2px solid #333;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: #0a0a0a;
        }

        .checkbox-wrapper label:hover {
            border-color: #666;
            background: #1a1a1a;
        }

        .checkbox-wrapper input[type="checkbox"]:checked + label {
            background: #2ecc40;
            border-color: #2ecc40;
        }

        .checkbox-wrapper input[type="checkbox"]:checked + label::after {
            content: '\2713';
            color: white;
            font-size: 16px;
            font-weight: 700;
        }

        /* Video */
        .video-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }

        .vid-input { display: none; }

        .vid-btn {
            display: inline-block;
            padding: 4px 10px;
            background: #222;
            color: #999;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .vid-btn:hover { background: #333; }

        .vid-player {
            width: 160px;
            max-height: 100px;
            border-radius: 6px;
            background: #000;
        }

        .vid-remove {
            background: none;
            border: 1px solid #3a2020;
            color: #e74c3c;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }

        .vid-remove:hover { background: #1f0a0a; }

        /* Notes */
        .note-input {
            width: 100%;
            min-width: 150px;
            padding: 6px 10px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            color: #d0d0d0;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            overflow: hidden;
            min-height: 32px;
            line-height: 1.4;
        }

        .note-input:focus { border-color: #555; }
        .note-input::placeholder { color: #444; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #555;
            font-size: 16px;
        }

        /* Mobile */
        @media (max-width: 700px) {
            header {
                padding: 14px 16px;
                flex-direction: column;
                gap: 10px;
            }

            header h1 { font-size: 22px; }
            .stats { gap: 12px; font-size: 12px; }
            .stats .stat-value { font-size: 14px; }

            .controls {
                padding: 10px 16px;
                flex-direction: column;
                gap: 10px;
            }

            .controls button { padding: 8px 14px; font-size: 13px; }
            .table-container { padding: 10px; }

            table, thead, tbody, tr, th, td { display: block; }
            thead { display: none; }

            tbody tr {
                border-radius: 10px;
                margin-bottom: 12px;
                padding: 14px;
                border: 1px solid #222;
            }

            tbody tr.complete {
                border: 1px solid #2ecc40;
                border-left: 4px solid #2ecc40;
            }

            tbody tr.incomplete {
                border: 1px solid #e74c3c;
                border-left: 4px solid #e74c3c;
            }

            tbody td {
                padding: 6px 0;
                text-align: left;
                border-bottom: none;
            }

            tbody td:first-child {
                padding-bottom: 10px;
                margin-bottom: 8px;
                border-bottom: 1px solid #222;
            }

            .date-cell {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            .date-cell .day-name { font-size: 12px; min-width: 40px; }
            .date-cell .date-text { font-size: 15px; font-weight: 600; }

            tbody td:nth-child(2),
            tbody td:nth-child(3),
            tbody td:nth-child(4) {
                display: flex;
                flex-direction: column;
                gap: 6px;
                padding: 8px 0;
                border-bottom: 1px solid #1a1a1a;
            }

            .meal-cell { width: 100%; }
            .meal-top { width: 100%; justify-content: space-between; }

            .checkbox-wrapper label { width: 34px; height: 34px; }
            .checkbox-wrapper input[type="checkbox"]:checked + label::after { font-size: 18px; }
            .meal-label { font-size: 13px; }

            .video-cell { flex-direction: row; justify-content: flex-start; gap: 8px; }
            .vid-player { width: 100%; max-height: 200px; }
            .vid-btn { padding: 8px 16px; font-size: 13px; }

            tbody td:nth-child(5) { padding-top: 10px; margin-top: 4px; }
            .note-input { min-width: unset; width: 100%; font-size: 14px; }
        }
    </style>
</head>
<body>
    <header>
        <h1><span>Alex</span> Timesheets</h1>
        <div class="stats">
            <div>Total Days: <span class="stat-value" id="totalDays">0</span></div>
            <div>Completed: <span class="stat-value" id="completedDays">0</span></div>
            <div>Progress: <span class="stat-value" id="progress">0%</span></div>
        </div>
    </header>
    <div class="controls">
        <div class="week-nav">
            <button id="prevWeek">&larr; Prev</button>
            <span id="weekLabel">Week 1</span>
            <button id="nextWeek">Next &rarr;</button>
        </div>
        <div style="display:flex; gap:8px;">
            <button id="jumpToday">Today</button>
            <button id="clearAll">Clear All</button>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Meal 1 - Eggs x2</th>
                    <th>Meal 2 - Lasagna</th>
                    <th>Meal 3 - Soup</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="5" class="loading">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // Week 1 starts Wed Feb 18, weeks run Mon-Sun except week 1
        const START_DATE = new Date(2026, 1, 18); // Wed Feb 18
        const END_DATE = new Date(2026, 6, 31);
        const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const MEAL_LABELS = { 1: 'Meal 1 - Eggs x2', 2: 'Meal 2 - Lasagna', 3: 'Meal 3 - Soup' };

        let savedData = {};
        let currentWeekPage = 0;

        // Build weeks: week 1 = Wed Feb 18 to Sun Feb 22, then Mon-Sun after
        const weeks = [];
        let cursor = new Date(START_DATE);

        // Week 1: Wed to Sun
        let week1 = [];
        while (cursor <= END_DATE && cursor.getDay() !== 1) { // stop when we hit Monday
            week1.push(new Date(cursor));
            cursor.setDate(cursor.getDate() + 1);
        }
        if (week1.length > 0) weeks.push(week1);

        // Remaining weeks: Mon to Sun
        while (cursor <= END_DATE) {
            let week = [];
            for (let i = 0; i < 7 && cursor <= END_DATE; i++) {
                week.push(new Date(cursor));
                cursor.setDate(cursor.getDate() + 1);
            }
            if (week.length > 0) weeks.push(week);
        }

        const allDates = weeks.flat();

        // --- Server API ---
        async function loadData() {
            try {
                const res = await fetch('/api/data');
                savedData = await res.json();
            } catch { savedData = {}; }
        }

        async function saveField(key, field, value) {
            if (!savedData[key]) savedData[key] = {};
            savedData[key][field] = value;
            const res = await fetch(`/api/data/${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: value })
            });
            // Reload the entry to get the server timestamp
            const fullData = await res.json();
            if (fullData.times) {
                Object.assign(savedData[key], fullData.times);
            }
        }

        async function uploadVideo(key, mealNum, file, cell) {
            const formData = new FormData();
            formData.append('video', file);
            cell.innerHTML = '<span style="color:#555;font-size:11px;">Uploading...</span>';
            try {
                const res = await fetch(`/api/video/${key}/${mealNum}`, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.ok) {
                    if (!savedData[key]) savedData[key] = {};
                    if (!savedData[key].videos) savedData[key].videos = {};
                    savedData[key].videos[`meal${mealNum}`] = data.filename;
                    showVideoPlayer(key, mealNum, cell);
                }
            } catch {
                cell.innerHTML = '<span style="color:#e74c3c;font-size:11px;">Upload failed</span>';
            }
        }

        async function deleteVideo(key, mealNum, cell) {
            await fetch(`/api/video/${key}/${mealNum}`, { method: 'DELETE' });
            if (savedData[key]?.videos) delete savedData[key].videos[`meal${mealNum}`];
            showVideoUpload(key, mealNum, cell);
        }

        async function clearAll() {
            await fetch('/api/data', { method: 'DELETE' });
            savedData = {};
            renderTable();
        }

        // --- Helpers ---
        function dateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        }

        function formatDate(date) {
            return `${date.getDate()} ${MONTHS[date.getMonth()]} ${date.getFullYear()}`;
        }

        function isToday(date) {
            const now = new Date();
            return date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }

        function isPast(date) {
            const now = new Date();
            now.setHours(0,0,0,0);
            const d = new Date(date);
            d.setHours(0,0,0,0);
            return d < now;
        }

        function hasVideo(key, mealNum) {
            return !!savedData[key]?.videos?.[`meal${mealNum}`];
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            const h = d.getHours();
            const m = String(d.getMinutes()).padStart(2, '0');
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${m} ${ampm}`;
        }

        function showVideoUpload(key, mealNum, cell) {
            const id = `vid-${key}-${mealNum}`;
            cell.innerHTML = `
                <input type="file" accept="video/*" id="${id}" class="vid-input">
                <label for="${id}" class="vid-btn">&#8679; Video</label>
            `;
            cell.querySelector(`#${id}`).addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) uploadVideo(key, mealNum, file, cell);
            });
        }

        function showVideoPlayer(key, mealNum, cell) {
            cell.innerHTML = `
                <video class="vid-player" controls src="/api/video/${key}/${mealNum}"></video>
                <button class="vid-remove">&#10005; Remove</button>
            `;
            cell.querySelector('.vid-remove').addEventListener('click', () => {
                deleteVideo(key, mealNum, cell);
            });
        }

        function getRowState(entry, date) {
            const ticks = (entry.meal1 ? 1 : 0) + (entry.meal2 ? 1 : 0) + (entry.meal3 ? 1 : 0);
            if (ticks === 3) return 'complete';
            if (ticks > 0) return 'incomplete';
            if (isPast(date)) return 'incomplete'; // past day with 0 ticks = red
            return ''; // future untouched
        }

        // --- Render ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const weekDates = weeks[currentWeekPage] || [];

            weekDates.forEach((date) => {
                const key = dateKey(date);
                const row = document.createElement('tr');
                const entry = savedData[key] || {};

                const state = getRowState(entry, date);
                if (state) row.classList.add(state);
                if (isToday(date)) row.classList.add('today');

                row.innerHTML = `
                    <td>
                        <div class="date-cell">
                            <span class="day-name">${DAYS[date.getDay()]}</span>
                            <span class="date-text">${formatDate(date)}</span>
                        </div>
                    </td>
                    ${[1,2,3].map(m => {
                        const timeStr = entry[`meal${m}_time`] ? `<span class="tick-time">${formatTime(entry[`meal${m}_time`])}</span>` : '';
                        return `
                        <td>
                            <div class="meal-cell">
                                <div class="meal-top">
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="m${m}-${key}" ${entry[`meal${m}`] ? 'checked' : ''}>
                                        <label for="m${m}-${key}"></label>
                                    </div>
                                    <span class="meal-label">${MEAL_LABELS[m]}</span>
                                </div>
                                ${timeStr}
                                <div class="video-cell" id="vid-cell-${key}-${m}"></div>
                            </div>
                        </td>`;
                    }).join('')}
                    <td>
                        <textarea class="note-input" id="note-${key}" rows="1" placeholder="Add a note...">${(entry.note || '').replace(/</g, '&lt;')}</textarea>
                    </td>
                `;

                // Checkbox listeners
                [1,2,3].forEach(m => {
                    row.querySelector(`#m${m}-${key}`).addEventListener('change', async (e) => {
                        await saveField(key, `meal${m}`, e.target.checked);
                        // Reload data to get timestamp then re-render
                        await loadData();
                        renderTable();
                    });
                });

                // Note listener
                const noteEl = row.querySelector(`#note-${key}`);
                let noteTimer;
                function autoGrow(el) {
                    el.style.height = 'auto';
                    el.style.height = el.scrollHeight + 'px';
                }
                autoGrow(noteEl);
                noteEl.addEventListener('input', (e) => {
                    autoGrow(e.target);
                    clearTimeout(noteTimer);
                    noteTimer = setTimeout(() => saveField(key, 'note', e.target.value), 500);
                });

                tbody.appendChild(row);

                // Video cells
                [1,2,3].forEach(m => {
                    const cell = row.querySelector(`#vid-cell-${key}-${m}`);
                    if (hasVideo(key, m)) showVideoPlayer(key, m, cell);
                    else showVideoUpload(key, m, cell);
                });
            });

            document.getElementById('weekLabel').textContent = `Week ${currentWeekPage + 1} of ${weeks.length}`;
            updateStats();
        }

        function updateStats() {
            const totalDays = allDates.length;
            let completed = 0;
            allDates.forEach(date => {
                const e = savedData[dateKey(date)];
                if (e && e.meal1 && e.meal2 && e.meal3) completed++;
            });
            const pct = totalDays > 0 ? Math.round((completed / totalDays) * 100) : 0;
            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('completedDays').textContent = completed;
            document.getElementById('progress').textContent = pct + '%';
        }

        function jumpToToday() {
            const now = new Date();
            const idx = weeks.findIndex(w => w.some(d =>
                d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()
            ));
            currentWeekPage = idx >= 0 ? idx : 0;
            renderTable();
        }

        // Navigation
        document.getElementById('prevWeek').addEventListener('click', () => {
            if (currentWeekPage > 0) { currentWeekPage--; renderTable(); }
        });
        document.getElementById('nextWeek').addEventListener('click', () => {
            if (currentWeekPage < weeks.length - 1) { currentWeekPage++; renderTable(); }
        });
        document.getElementById('jumpToday').addEventListener('click', jumpToToday);
        document.getElementById('clearAll').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear ALL data including videos?')) clearAll();
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'ArrowLeft') document.getElementById('prevWeek').click();
            else if (e.key === 'ArrowRight') document.getElementById('nextWeek').click();
        });

        // Init
        loadData().then(() => jumpToToday());
    </script>
</body>
</html>
